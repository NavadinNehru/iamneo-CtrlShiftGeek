import requests
import time

def check_file_virustotal(api_key, file_path):
    # VirusTotal API URL
    url = "https://www.virustotal.com/vtapi/v2/file/scan"
    report_url = "https://www.virustotal.com/vtapi/v2/file/report"
    
    # Read the file
    files = {'file': (file_path, open(file_path, 'rb'))}
    params = {'apikey': api_key}
    
    # Upload the file for scanning
    response = requests.post(url, files=files, params=params)
    
    if response.status_code == 200:
        # Retrieve the scan ID from the response
        response_data = response.json()
        print(response_data)
        scan_id = response_data['scan_id']
        print("File uploaded successfully. Scan ID:", scan_id)
        
        # Check the report status using the scan ID
        report_params = {'apikey': api_key, 'resource': scan_id}
        
        # Wait a few seconds before requesting the scan report
        print("Waiting for scan results...")
        time.sleep(180)  # Adjust the wait time as needed
        
        report_response = requests.get(report_url, params=report_params)
        if report_response.status_code == 200:
            report_data = report_response.json()
            response_code = report_data.get('response_code')
            if response_code == 1:  # 1 means the scan report is available
                positives = report_data.get('positives')
                total = report_data.get('total')
                print(f"Detection Ratio: {positives}/{total}")
                if positives > 0:
                    print("The file is detected as malicious.")
                else:
                    print("The file is malware-free.")
            else:
                print("Report not available yet, please try again later.")
        else:
            print("Error fetching the scan report:", report_response.status_code)
    else:
        print("Error uploading the file:", response.status_code)

# Usage
api_key = 'f09f88b572356f8a159327794b324e0030fd174efa2d3435b67b625eeff57f4c'
file_path = './data.json'
check_file_virustotal(api_key, file_path)